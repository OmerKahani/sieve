package main

import (
	"log"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestIsCrucial(t *testing.T) {
	log.SetFlags(log.LstdFlags | log.Lshortfile)
	crucialEvent := `{"spec": {"nodeName": "SONAR-NON-NIL"}, "status": {"conditions": [{"type":
	"PodScheduled", "status": "True", "lastProbeTime": null, "lastTransitionTime": "SONAR-NON-NIL"}]}}`
	currentEvent := `{"name":"mongodb-cluster-cfg-1","generateName":"mongodb-cluster-cfg-","namespace":"default","uid":"f42f5c0e-4ff7-41f9-b27e-adf154316e3d","resourceVersion":"1681","creationTimestamp":"2021-06-06T08:22:17Z","labels":{"app.kubernetes.io/component":"cfg","app.kubernetes.io/instance":"mongodb-cluster","app.kubernetes.io/managed-by":"percona-server-mongodb-operator","app.kubernetes.io/name":"percona-server-mongodb","app.kubernetes.io/part-of":"percona-server-mongodb","app.kubernetes.io/replset":"cfg","controller-revision-hash":"mongodb-cluster-cfg-b7b5fb94","statefulset.kubernetes.io/pod-name":"mongodb-cluster-cfg-1"},"annotations":{"percona.com/ssl-hash":"55b9aa7cf78275dc3b73d0623c7813ad","percona.com/ssl-internal-hash":"84921b557019efa23be696fceb011ce6"},"ownerReferences":[{"apiVersion":"apps/v1","kind":"StatefulSet","name":"mongodb-cluster-cfg","uid":"38392e90-13c0-42d1-a5ac-5e11870a381a","controller":true,"blockOwnerDeletion":true}],"managedFields":[{"manager":"kube-controller-manager","operation":"Update","apiVersion":"v1","time":"2021-06-06T08:22:17Z","fieldsType":"FieldsV1","fieldsV1":{"f:metadata":{"f:annotations":{".":{},"f:percona.com/ssl-hash":{},"f:percona.com/ssl-internal-hash":{}},"f:generateName":{},"f:labels":{".":{},"f:app.kubernetes.io/component":{},"f:app.kubernetes.io/instance":{},"f:app.kubernetes.io/managed-by":{},"f:app.kubernetes.io/name":{},"f:app.kubernetes.io/part-of":{},"f:app.kubernetes.io/replset":{},"f:controller-revision-hash":{},"f:statefulset.kubernetes.io/pod-name":{}},"f:ownerReferences":{".":{},"k:{\"uid\":\"38392e90-13c0-42d1-a5ac-5e11870a381a\"}":{".":{},"f:apiVersion":{},"f:blockOwnerDeletion":{},"f:controller":{},"f:kind":{},"f:name":{},"f:uid":{}}}},"f:spec":{"f:affinity":{".":{},"f:podAntiAffinity":{".":{},"f:requiredDuringSchedulingIgnoredDuringExecution":{}}},"f:containers":{"k:{\"name\":\"mongod\"}":{".":{},"f:args":{},"f:command":{},"f:env":{".":{},"k:{\"name\":\"MONGODB_PORT\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"MONGODB_REPLSET\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"NAMESPACE\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"SERVICE_NAME\"}":{".":{},"f:name":{},"f:value":{}}},"f:envFrom":{},"f:image":{},"f:imagePullPolicy":{},"f:livenessProbe":{".":{},"f:exec":{".":{},"f:command":{}},"f:failureThreshold":{},"f:initialDelaySeconds":{},"f:periodSeconds":{},"f:successThreshold":{},"f:timeoutSeconds":{}},"f:name":{},"f:ports":{".":{},"k:{\"containerPort\":27017,\"protocol\":\"TCP\"}":{".":{},"f:containerPort":{},"f:name":{},"f:protocol":{}}},"f:readinessProbe":{".":{},"f:failureThreshold":{},"f:initialDelaySeconds":{},"f:periodSeconds":{},"f:successThreshold":{},"f:tcpSocket":{".":{},"f:port":{}},"f:timeoutSeconds":{}},"f:resources":{".":{},"f:limits":{".":{},"f:cpu":{},"f:memory":{}},"f:requests":{".":{},"f:cpu":{},"f:memory":{}}},"f:securityContext":{".":{},"f:runAsNonRoot":{},"f:runAsUser":{}},"f:terminationMessagePath":{},"f:terminationMessagePolicy":{},"f:volumeMounts":{".":{},"k:{\"mountPath\":\"/data/db\"}":{".":{},"f:mountPath":{},"f:name":{}},"k:{\"mountPath\":\"/etc/mongodb-encryption\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}},"k:{\"mountPath\":\"/etc/mongodb-secrets\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}},"k:{\"mountPath\":\"/etc/mongodb-ssl\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}},"k:{\"mountPath\":\"/etc/mongodb-ssl-internal\"}":{".":{},"f:mountPath":{},"f:name":{},"f:readOnly":{}}},"f:workingDir":{}}},"f:dnsPolicy":{},"f:enableServiceLinks":{},"f:hostname":{},"f:initContainers":{".":{},"k:{\"name\":\"mongo-init\"}":{".":{},"f:command":{},"f:image":{},"f:imagePullPolicy":{},"f:name":{},"f:resources":{".":{},"f:limits":{".":{},"f:cpu":{},"f:memory":{}},"f:requests":{".":{},"f:cpu":{},"f:memory":{}}},"f:terminationMessagePath":{},"f:terminationMessagePolicy":{},"f:volumeMounts":{".":{},"k:{\"mountPath\":\"/data/db\"}":{".":{},"f:mountPath":{},"f:name":{}}}}},"f:restartPolicy":{},"f:schedulerName":{},"f:securityContext":{".":{},"f:fsGroup":{}},"f:serviceAccount":{},"f:serviceAccountName":{},"f:subdomain":{},"f:terminationGracePeriodSeconds":{},"f:volumes":{".":{},"k:{\"name\":\"mongod-data\"}":{".":{},"f:name":{},"f:persistentVolumeClaim":{".":{},"f:claimName":{}}},"k:{\"name\":\"mongodb-cluster-mongodb-encryption-key\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}},"k:{\"name\":\"mongodb-cluster-mongodb-keyfile\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}},"k:{\"name\":\"ssl\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}},"k:{\"name\":\"ssl-internal\"}":{".":{},"f:name":{},"f:secret":{".":{},"f:defaultMode":{},"f:optional":{},"f:secretName":{}}}}}}}],"Spec":{"Volumes":[{"Name":"mongod-data","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":null,"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":{"ClaimName":"mongod-data-mongodb-cluster-cfg-1","ReadOnly":false},"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"mongodb-cluster-mongodb-keyfile","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-mongodb-keyfile","Items":null,"DefaultMode":288,"Optional":false},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"mongodb-cluster-mongodb-encryption-key","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-mongodb-encryption-key","Items":null,"DefaultMode":288,"Optional":false},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"ssl","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-ssl","Items":null,"DefaultMode":288,"Optional":false},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"ssl-internal","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"mongodb-cluster-ssl-internal","Items":null,"DefaultMode":288,"Optional":true},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null},{"Name":"default-token-xvwsw","HostPath":null,"EmptyDir":null,"GCEPersistentDisk":null,"AWSElasticBlockStore":null,"GitRepo":null,"Secret":{"SecretName":"default-token-xvwsw","Items":null,"DefaultMode":420,"Optional":null},"NFS":null,"ISCSI":null,"Glusterfs":null,"PersistentVolumeClaim":null,"RBD":null,"Quobyte":null,"FlexVolume":null,"Cinder":null,"CephFS":null,"Flocker":null,"DownwardAPI":null,"FC":null,"AzureFile":null,"ConfigMap":null,"VsphereVolume":null,"AzureDisk":null,"PhotonPersistentDisk":null,"Projected":null,"PortworxVolume":null,"ScaleIO":null,"StorageOS":null,"CSI":null}],"InitContainers":[{"Name":"mongo-init","Image":"laphets/mongodb-operator:time-travel","Command":["/init-entrypoint.sh"],"Args":null,"WorkingDir":"","Ports":null,"EnvFrom":null,"Env":null,"Resources":{"Limits":{"cpu":"300m","memory":"500M"},"Requests":{"cpu":"300m","memory":"500M"}},"VolumeMounts":[{"Name":"mongod-data","ReadOnly":false,"MountPath":"/data/db","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"default-token-xvwsw","ReadOnly":true,"MountPath":"/var/run/secrets/kubernetes.io/serviceaccount","SubPath":"","MountPropagation":null,"SubPathExpr":""}],"VolumeDevices":null,"LivenessProbe":null,"ReadinessProbe":null,"StartupProbe":null,"Lifecycle":null,"TerminationMessagePath":"/dev/termination-log","TerminationMessagePolicy":"File","ImagePullPolicy":"Always","SecurityContext":null,"Stdin":false,"StdinOnce":false,"TTY":false}],"Containers":[{"Name":"mongod","Image":"percona/percona-server-mongodb:4.4.3-5","Command":["/data/db/ps-entry.sh"],"Args":["--bind_ip_all","--auth","--dbpath=/data/db","--port=27017","--replSet=cfg","--storageEngine=wiredTiger","--relaxPermChecks","--sslAllowInvalidCertificates","--sslMode=preferSSL","--clusterAuthMode=x509","--configsvr","--slowms=100","--profile=1","--rateLimit=100","--enableEncryption","--encryptionKeyFile=/etc/mongodb-encryption/encryption-key","--encryptionCipherMode=AES256-CBC","--wiredTigerCacheSizeGB=0.25","--wiredTigerCollectionBlockCompressor=snappy","--wiredTigerJournalCompressor=snappy","--wiredTigerIndexPrefixCompression=true","--setParameter","ttlMonitorSleepSecs=60","--setParameter","wiredTigerConcurrentReadTransactions=128","--setParameter","wiredTigerConcurrentWriteTransactions=128"],"WorkingDir":"/data/db","Ports":[{"Name":"mongodb","HostPort":0,"ContainerPort":27017,"Protocol":"TCP","HostIP":""}],"EnvFrom":[{"Prefix":"","ConfigMapRef":null,"SecretRef":{"Name":"internal-mongodb-cluster-users","Optional":false}}],"Env":[{"Name":"SERVICE_NAME","Value":"mongodb-cluster","ValueFrom":null},{"Name":"NAMESPACE","Value":"default","ValueFrom":null},{"Name":"MONGODB_PORT","Value":"27017","ValueFrom":null},{"Name":"MONGODB_REPLSET","Value":"cfg","ValueFrom":null}],"Resources":{"Limits":{"cpu":"300m","memory":"500M"},"Requests":{"cpu":"300m","memory":"500M"}},"VolumeMounts":[{"Name":"mongod-data","ReadOnly":false,"MountPath":"/data/db","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"mongodb-cluster-mongodb-keyfile","ReadOnly":true,"MountPath":"/etc/mongodb-secrets","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"ssl","ReadOnly":true,"MountPath":"/etc/mongodb-ssl","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"ssl-internal","ReadOnly":true,"MountPath":"/etc/mongodb-ssl-internal","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"mongodb-cluster-mongodb-encryption-key","ReadOnly":true,"MountPath":"/etc/mongodb-encryption","SubPath":"","MountPropagation":null,"SubPathExpr":""},{"Name":"default-token-xvwsw","ReadOnly":true,"MountPath":"/var/run/secrets/kubernetes.io/serviceaccount","SubPath":"","MountPropagation":null,"SubPathExpr":""}],"VolumeDevices":null,"LivenessProbe":{"Exec":{"Command":["/data/db/mongodb-healthcheck","k8s","liveness","--ssl","--sslInsecure","--sslCAFile","/etc/mongodb-ssl/ca.crt","--sslPEMKeyFile","/tmp/tls.pem","--startupDelaySeconds","7200"]},"HTTPGet":null,"TCPSocket":null,"InitialDelaySeconds":60,"TimeoutSeconds":5,"PeriodSeconds":30,"SuccessThreshold":1,"FailureThreshold":4},"ReadinessProbe":{"Exec":null,"HTTPGet":null,"TCPSocket":{"Port":27017,"Host":""},"InitialDelaySeconds":10,"TimeoutSeconds":2,"PeriodSeconds":3,"SuccessThreshold":1,"FailureThreshold":8},"StartupProbe":null,"Lifecycle":null,"TerminationMessagePath":"/dev/termination-log","TerminationMessagePolicy":"File","ImagePullPolicy":"Always","SecurityContext":{"Capabilities":null,"Privileged":null,"SELinuxOptions":null,"WindowsOptions":null,"RunAsUser":1001,"RunAsGroup":null,"RunAsNonRoot":true,"ReadOnlyRootFilesystem":null,"AllowPrivilegeEscalation":null,"ProcMount":null},"Stdin":false,"StdinOnce":false,"TTY":false}],"EphemeralContainers":null,"RestartPolicy":"Always","TerminationGracePeriodSeconds":30,"ActiveDeadlineSeconds":null,"DNSPolicy":"ClusterFirst","NodeSelector":null,"ServiceAccountName":"default","AutomountServiceAccountToken":null,"NodeName":"kind-worker","SecurityContext":{"HostNetwork":false,"HostPID":false,"HostIPC":false,"ShareProcessNamespace":null,"SELinuxOptions":null,"WindowsOptions":null,"RunAsUser":null,"RunAsGroup":null,"RunAsNonRoot":null,"SupplementalGroups":null,"FSGroup":1001,"FSGroupChangePolicy":null,"Sysctls":null},"ImagePullSecrets":null,"Hostname":"mongodb-cluster-cfg-1","Subdomain":"mongodb-cluster-cfg","Affinity":{"NodeAffinity":null,"PodAffinity":null,"PodAntiAffinity":{"RequiredDuringSchedulingIgnoredDuringExecution":[{"LabelSelector":{"matchLabels":{"app.kubernetes.io/component":"cfg","app.kubernetes.io/instance":"mongodb-cluster","app.kubernetes.io/managed-by":"percona-server-mongodb-operator","app.kubernetes.io/name":"percona-server-mongodb","app.kubernetes.io/part-of":"percona-server-mongodb","app.kubernetes.io/replset":"cfg"}},"Namespaces":null,"TopologyKey":"kubernetes.io/hostname"}],"PreferredDuringSchedulingIgnoredDuringExecution":null}},"SchedulerName":"default-scheduler","Tolerations":[{"Key":"node.kubernetes.io/not-ready","Operator":"Exists","Value":"","Effect":"NoExecute","TolerationSeconds":300},{"Key":"node.kubernetes.io/unreachable","Operator":"Exists","Value":"","Effect":"NoExecute","TolerationSeconds":300}],"HostAliases":null,"PriorityClassName":"","Priority":0,"PreemptionPolicy":null,"DNSConfig":null,"ReadinessGates":null,"RuntimeClassName":null,"Overhead":null,"EnableServiceLinks":true,"TopologySpreadConstraints":null},"Status":{"Phase":"Pending","Conditions":[{"Type":"PodScheduled","Status":"True","LastProbeTime":null,"LastTransitionTime":"2021-06-06T08:22:20Z","Reason":"","Message":""}],"Message":"","Reason":"","NominatedNodeName":"","HostIP":"","PodIPs":null,"StartTime":null,"QOSClass":"Guaranteed","InitContainerStatuses":null,"ContainerStatuses":null,"EphemeralContainerStatuses":null}}`
	assert.True(t, isCrucial(strToMap(crucialEvent), strToMap(currentEvent)), "Crucial event detect fail")
}
